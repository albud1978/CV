# Changelog

Все значимые изменения проекта документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/).

## [Unreleased]

### Добавлено
- **Детекция движения** (`src/utils/motion_detect.py`): автоматическая нарезка видео на клипы с движением
  - Background Subtraction (MOG2) для обнаружения движения
  - Настраиваемый буфер после прекращения движения (по умолчанию 60 сек)
  - Объединение близких сегментов
- **Видео-пайплайн YOLO**: обработка видео с детекцией, сегментацией и трекингом
  - Детекция объектов (YOLOv8l) → `output/yolo_video/annotated_result.mp4`
  - Сегментация (YOLOv8l-seg) → `output/yolo_video/segmented_result.mp4`
  - Трекинг с траекториями и стрелками направления → `output/yolo_video/tracking_named.mp4`
- **Авторазметка кадров**: тестирование YOLOv8 и RF-DETR на извлечённых кадрах
  - YOLOv8l → `output/test_yolo/` (labels + visualized)
  - RF-DETR Small → `output/test_rf_detr/` (labels + visualized)
- **Molmo 2 Интеграция**:
  - Обновлена документация по **Molmo 2**: добавлена детальная информация о семействе моделей (4B, 8B, VideoPoint), их возможностях (grounded video understanding) и открытых датасетах.
  - Обновлен скрипт `src/utils/download_models.py`: добавлена функция кэширования процессоров Molmo 2.
  - В `src/inference/molmo2.py` подтверждена поддержка новых моделей `Molmo2-4B`, `Molmo2-8B` и `Molmo2-VideoPoint-4B`.
  - Добавлен скрипт `src/inference/molmo_demo.py` для альтернативного запуска инференса.
- Обновлен `requirements.txt`: добавлены зависимости для **Molmo 2** (`transformers`, `accelerate`, `einops`, `bitsandbytes`, `decord`).

### Изменено
- Оптимизирована эталонная архитектура (`REFERENCE_ARCHITECTURE.md`) с учетом последних SOTA-практик конца 2025 года.

### Исправлено
- **Docker и Среда**:
  - Устранены зависания при сборке Docker: оптимизировано потребление VRAM (выключены конфликтующие контейнеры Ollama/VLLM).
  - Исправлена проблема с GPU в Docker: после перезапуска контейнера CUDA становится доступна.
  - Исправлена проблема с монтированием томов Docker: удалены битые симлинки `input`/`output`, созданы локальные директории.
  - Сгенерирован файл `.env` для корректного запуска на текущем хосте.
- **Инференс и Код**:
  - Исправлен потенциальный краш в `src/inference/sam2_demo.py` при отсутствии валидного промпта (проверка `masks is None`).
  - Добавлена проверка на валидность изображения в `src/inference/dino_1_5_api.py` (защита от `AttributeError` если `imread` вернет `None`).
  - Добавлена проверка на валидность изображения в `src/inference/text_search.py` (защита от `AttributeError` если `imread` вернет `None`).
  - Доработана логика загрузки моделей в `src/inference/molmo2.py`: добавлен фолбек на `AutoModel` при ошибке распознавания кастомного конфига `Molmo2Config` в `AutoModelForCausalLM`.
- **Документация**:
  - Исправлена ошибка в документации (`REFERENCE_ARCHITECTURE.md`): модели Molmo 2 (4B/8B) теперь корректно указаны на базе **OLMo 2**, а не Qwen 3 (устранено ошибочное упоминание Qwen).

### Результаты экспериментов (2025-12-18)

**Оборудование:** NVIDIA GeForce RTX 5090, Ubuntu 24.04, Docker

| Модель | Задача | Скорость | Результат |
|--------|--------|----------|-----------|
| YOLOv8l | Детекция | ~5 мс/кадр | Обнаружены: person, airplane, truck |
| YOLOv8l-seg | Сегментация | ~5 мс/кадр | Контуры объектов |
| YOLOv8l + tracking | Трекинг | ~5 мс/кадр | 8 объектов с траекториями |
| RF-DETR Small | Детекция | ~3 мс/кадр | COCO классы |

**Тестовое видео:** 21673 кадра (14 мин), 1280x720, 25 FPS
**Время обработки:** ~2 минуты на полное видео

---

### Добавлено
- Обновлен `requirements.txt`: добавлена установка SAM 2 (git), Roboflow Inference, RF-DETR
- Скрипт авторазметки данных `src/utils/auto_label.py` (использует YOLOv8x/l)
- Скрипт загрузки моделей `src/utils/download_models.py`
- Обновлен `requirements.txt` (добавлены `ultralytics`, `roboflow`, `supervision`)
- Обновлен `README.md` (инструкция по запуску через Docker)
- Создана структура подкаталогов в `src/` (models, utils, configs, train, inference)
- Добавлена Docker-среда (`Dockerfile`, `docker-compose.yml`) с поддержкой GPU
- Создана папка `docs` для документации
- Инициализация проекта
- Создана базовая структура папок
- Настроены симлинки на Nextcloud для input/output данных
- Добавлен README.md с описанием проекта
- Добавлен .gitignore
- Добавлены правила ведения проекта (.cursorrules)

---

## Шаблон записи

```markdown
## [X.Y.Z] - YYYY-MM-DD

### Добавлено
- Новые функции

### Изменено
- Изменения в существующей функциональности

### Исправлено
- Исправления ошибок

### Удалено
- Удалённые функции

### Результаты
- Метрики и результаты экспериментов
```
